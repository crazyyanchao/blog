---
title: Nginx请求转发失败原因排查
tags: [Nginx,GraphQL]
author: Yc-Ma
show_author_profile: true
key: 2020-11-11-Nginx请求转发失败原因排查
pageview: true
---

Here's the table of contents:
1. TOC
{:toc}

### 【一】日志报错
```
2020/11/11 06:04:25 [error] 25231#0: *7461416 connect() failed (111: Connection refused) while connecting to upstream, client: 10.10.39.169, server: datalab.graphql.http.server, request: "POST /ongdb/graphql HTTP/1.1", upstream: "http://10.20.13.58:7424/ongdb/graphql", host: "10.20.13.130"
```
### 【二】报错解析
客户端10.10.39.169访问datalab.graphql.http.server服务时，请求被转发到了10.20.13.58:7424，但是因为某些原因导致转发失败，所以发生报错

### 【三】报错原因
主要从网络和服务两方面进行排查
- IP不通
- 端口不通
- 服务不可用等
```
# 排查网络可以用
telnet ip port
```
```
# 排查服务可以用
ps -ef | grep serverName
```

### 【一】日志报错
```
2020/11/09 06:30:26 [crit] 4013#0: accept4() failed (24: Too many open files)
```
### 【二】报错解析
```
操作系统可打开文件数限制导致
```

### 【三】报错解决
- 修改最大可打开文件数
```
ulimit -n 65536
ulimit -a
# hard nofile 65536
# soft nofile 65536
sudo vim /etc/security/limits.conf
# sudo ulimit -n 65536 报错：sudo: ulimit: command not found，则使用下面的名称
# 修改LOGNAME
sudo sh -c "ulimit -n 65535 && exec su $LOGNAME"
```

